- if mobile_device?
  = render partial: 'brews/components/actionbar', locals: { title: "#{@profile.firstname}", back: true, back_icon: 'keyboard_arrow_left', back_url: conversations_path }

- firebase_token = Firebase::FirebaseTokenGenerator.new("#{ENV['FIREBASE_SECRET']}").create_token({ uid: current_profile.uuid })

main
  .max960
    .conversation__container
      .messages
    .conversation__send-message
      = text_field_tag 'message', '', placeholder: 'Your message to the group', class: 'mdl-textfield__input message-box'
      .send-message
        i.material-icons send

  javascript:
    var current_profile_uuid = "#{current_profile.uuid}";
    var photo_ids = JSON.parse('#{@photo_ids_hash.to_json.to_s.html_safe}');
    var names = JSON.parse('#{@names_hash.to_json.to_s.html_safe}');

    var ref = new Firebase("#{Rails.application.config.firebase_db_url}");
    ref.authWithCustomToken("#{firebase_token}", function(error, authData) {
      if (error) {
        console.log("Login Failed!", error);
      } else {
        console.log("Login Succeeded!", authData);
      }
    });

    var conversationRef = new Firebase("#{Rails.application.config.firebase_db_url}conversations/#{@conversation.uuid}/messages");

    var firstQuery = conversationRef.orderByChild("sent_at").limitToLast(25);

    firstQuery.on('child_added', function(snapshot) {
      var $elem;
      var oldHeight = $('.messages').height();
      var data = snapshot.val();

      // if(data.sender_uuid === current_profile_uuid) {
      if(Math.random() > 0.5) {
        $elem = $('<div class="conversation__chat-bubble sent">' +
                                '<div class="text">' + '<span class="accent-color--title bold">' + names[data.sender_uuid] + '</span>'  + '<br>' + data.content + '</div>' +
                                '<div class="avatar"><image src="' +
                                  $.cloudinary.url(photo_ids[data.sender_uuid], { width: 48, height: 48, crop: 'fill', gravity: 'face', radius: 'max' })  +
                                '"/></div>' +
                              '</div>');
        $('.messages').append($elem);
      } else {
        $elem = $('<div class="conversation__chat-bubble received">' +
                                '<div class="avatar"><image src="' +
                                  $.cloudinary.url(photo_ids[data.sender_uuid], { width: 48, height: 48, crop: 'fill', gravity: 'face', radius: 'max' })  +
                                '"/></div>' +
                                '<div class="text">' + '<span class="accent-color--title bold">' + names[data.sender_uuid] + '</span>'  + '<br>' + data.content + '</div>' +
                              '</div>');
        $('.messages').append($elem);
      }

      //$('.messages').height(oldHeight + );

      //window.scrollTo(0, document.body.scrollHeight);
      //document.body.scrollTop = document.body.scrollHeight - document.body.clientHeight;
      $(".conversation__container").scrollTop($(".conversation__container .messages")[0].scrollHeight);
    });

    $('#message').on('keypress', function(e) {
      if($('#message').val() == "") return;

      if(e.which == 13) {
        conversationRef.push({ content: $(this).val(),
                                sender_uuid: current_profile_uuid,
                                recipient_uuid: null,
                                sent_at: Date.now(),
                                processed: true });
        $(this).val('');
      }
    });

    $('.send-message').on('click', function(e) {
      e.preventDefault();

      if($('#message').val() == "") return;

      conversationRef.push({ content: $('#message').val(),
                              sender_uuid: current_profile_uuid,
                              recipient_uuid: null,
                              sent_at: Date.now(),
                              processed: true });
      $('#message').val('');
    });

    $('#message').on('focus', function() {
      $('.conversation__send-message').css({ 'position': 'relative', "margin-top": -25 });
      $('.conversation__container .messages').css({ "margin-top": -25 });

      setTimeout(function () {
          window.scrollTo(document.body.scrollLeft, document.body.scrollTop);
      }, 0);
    });

    $('#message').on('blur', function() {
      $('.conversation__send-message').css({ 'position': 'fixed', "margin-top": 0 });
      $('.conversation__container .messages').css({ "margin-top": 0 });

      setTimeout(function () {
          window.scrollTo(document.body.scrollLeft, document.body.scrollTop);
      }, 0);
    });

    $(document).on('touchstart', 'input, textarea', function () {
        setTimeout(function () {
            window.scrollTo(document.body.scrollLeft, document.body.scrollTop);
        }, 0);
    });
